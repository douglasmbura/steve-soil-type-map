<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kenya Soil Types Map - Concentric Rings</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        h1 i {
            color: #e74c3c;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .stats {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-content {
            display: flex;
            gap: 20px;
            height: 75vh;
        }

        .map-container {
            flex: 3;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .sidebar {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #3498db;
        }

        .legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .legend-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }

        .color-box {
            width: 25px;
            height: 25px;
            border-radius: 5px;
            border: 2px solid #fff;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .soil-name {
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
        }

        .count {
            background: #ecf0f1;
            color: #7f8c8d;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select, .slider-container {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
        }

        select:focus, .slider-container:focus-within {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
        }

        .slider-value {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .layer-toggle:hover {
            background: #e9ecef;
        }

        .layer-toggle.active {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .toggle-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #28a745;
        }

        .toggle-label {
            flex: 1;
            cursor: pointer;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }

        .soil-type-header {
            background: linear-gradient(90deg, #8e44ad, #9b59b6);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .location-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            margin-top: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #dee2e6;
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
        }

        .info-value {
            color: #6c757d;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-btn {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #2c3e50;
            transition: all 0.3s;
        }

        .map-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .ring-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
        }

        .ring-sample {
            display: inline-block;
            width: 15px;
            height: 3px;
            border-radius: 2px;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .map-container, .sidebar {
                height: 600px;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .map-container, .sidebar {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> Kenya Soil Types Map - Concentric Rings</h1>
            <div class="subtitle">Interactive visualization with concentric rings for multiple soil types at same location</div>
            <div class="stats">
                <div class="stat-item"><i class="fas fa-layer-group"></i> <span id="total-soil-types">16</span> Soil Types</div>
                <div class="stat-item"><i class="fas fa-map-marker-alt"></i> <span id="total-locations">36</span> Locations</div>
                <div class="stat-item"><i class="fas fa-bullseye"></i> <span id="multi-soil-locations">0</span> Multi-soil Locations</div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="map-btn" id="zoom-to-kenya">
                        <i class="fas fa-search-location"></i> Zoom to Kenya
                    </button>
                    <button class="map-btn" id="reset-view">
                        <i class="fas fa-sync-alt"></i> Reset View
                    </button>
                    <button class="map-btn" id="toggle-rings">
                        <i class="fas fa-circle"></i> Toggle Rings
                    </button>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="soil-type-header">
                    <i class="fas fa-legend"></i> Soil Type Legend
                </div>
                
                <div class="legend" id="legend"></div>
                
                <div class="controls">
                    <div class="section-title"><i class="fas fa-sliders-h"></i> Map Controls</div>
                    
                    <div class="control-group">
                        <label><i class="fas fa-layer-group"></i> Base Map</label>
                        <select id="baseMapSelector">
                            <option value="osm">OpenStreetMap</option>
                            <option value="esri">ESRI Satellite</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label><i class="fas fa-draw-polygon"></i> Ring Opacity</label>
                        <div class="slider-container">
                            <input type="range" id="opacitySlider" min="0" max="100" value="60">
                            <span class="slider-value" id="opacityValue">60%</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label><i class="fas fa-expand-arrows-alt"></i> Max Ring Radius (km)</label>
                        <div class="slider-container">
                            <input type="range" id="maxRadiusSlider" min="5" max="50" value="25">
                            <span class="slider-value" id="maxRadiusValue">25 km</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label><i class="fas fa-ruler"></i> Ring Thickness (km)</label>
                        <div class="slider-container">
                            <input type="range" id="thicknessSlider" min="1" max="10" value="3">
                            <span class="slider-value" id="thicknessValue">3 km</span>
                        </div>
                    </div>
                    
                    <div class="layer-toggle active" id="togglePoints">
                        <input type="checkbox" class="toggle-checkbox" id="pointsCheckbox" checked>
                        <label class="toggle-label" for="pointsCheckbox">Show Location Markers</label>
                    </div>
                    
                    <div class="layer-toggle active" id="toggleRings">
                        <input type="checkbox" class="toggle-checkbox" id="ringsCheckbox" checked>
                        <label class="toggle-label" for="ringsCheckbox">Show Soil Type Rings</label>
                    </div>
                    
                    <div class="layer-toggle active" id="toggleLabels">
                        <input type="checkbox" class="toggle-checkbox" id="labelsCheckbox" checked>
                        <label class="toggle-label" for="labelsCheckbox">Show Ring Labels</label>
                    </div>
                </div>
                
                <div class="location-info" id="selectedInfo" style="display: none;">
                    <div class="section-title"><i class="fas fa-info-circle"></i> Selected Location</div>
                    <div id="locationDetails"></div>
                </div>
                
                <div class="location-info" id="ringLegend">
                    <div class="section-title"><i class="fas fa-bullseye"></i> Ring Pattern Guide</div>
                    <div id="ringPatternInfo">Inner rings represent most common soil types at each location</div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Data Source: Geocoded Soil Type Locations | Created with Leaflet.js & OpenStreetMap</p>
            <p>© 2024 Kenya Soil Mapping Project | Concentric rings represent multiple soil types at same location</p>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Soil type color mapping
        const soilColors = {
            "Clay Yellow": "#FFD700", // Gold
            "Black Clay": "#2C3E50",  // Dark Blue Gray
            "Soil White": "#F5F5F5",  // White Smoke
            "Clay": "#D35400",        // Pumpkin
            "White Soil": "#ECF0F1",  // Silver
            "Stone": "#7F8C8D",       // Gray
            "Kaolin Soil": "#E74C3C", // Red
            "Yellow": "#F1C40F",      // Sunflower
            "Clay Black": "#34495E",  // Wet Asphalt
            "Silica (Quartz)": "#1ABC9C", // Turquoise
            "Ball Clay": "#8E44AD",   // Wisteria
            "Feldspar (Flux)": "#16A085", // Green Sea
            "Limestone (calcium carbonate)": "#95A5A6", // Concrete
            "Dolomite (calcium magnesium carbonate)": "#7D3C98", // Plum
            "Talc": "#27AE60",        // Nephritis
            "Soapstone": "#3498DB"    // Peter River
        };

        // Parse CSV data and group by location
        const soilData = [
            {"Soil Type": "Clay Yellow", "Location Name": "MAJENGO (Vihiga)", "latitude": 0.0503153, "longitude": 34.7260582, "formatted": "Majengo (Central Maragoli ward), Vihiga County, Kenya"},
            {"Soil Type": "Black Clay", "Location Name": "CHIGA", "latitude": -0.0982355, "longitude": 34.8459032, "formatted": "Chiga, Kisumu County, Kenya"},
            {"Soil Type": "Black Clay", "Location Name": "SEME", "latitude": -0.10540565, "longitude": 34.50833243, "formatted": "Seme, Kenya"},
            {"Soil Type": "Soil White", "Location Name": "SIAYA", "latitude": -0.06040135, "longitude": 34.20013501, "formatted": "Siaya County, Kenya"},
            {"Soil Type": "Clay Yellow", "Location Name": "MAJENGO (Vihiga)", "latitude": 0.0490121, "longitude": 34.7292226, "formatted": "Spiro Charging Station, Majengo-Hamisi Road, Vihiga, 50316, Kenya"},
            {"Soil Type": "Soapstone", "Location Name": "KISII", "latitude": -0.73894255, "longitude": 34.75398551, "formatted": "Kisii County, Kenya"},
            {"Soil Type": "Soapstone", "Location Name": "SEREM (VIHIGA)", "latitude": 0.0779324, "longitude": 34.8555317, "formatted": "Serem (Shamakhokho ward), Vihiga County, Kenya"},
            {"Soil Type": "Clay", "Location Name": "MAJENGO (Vihiga)", "latitude": 0.0490121, "longitude": 34.7292226, "formatted": "Spiro Charging Station, Majengo-Hamisi Road, Vihiga, 50316, Kenya"},
            {"Soil Type": "Clay", "Location Name": "KERICHO", "latitude": -0.3209968, "longitude": 35.2261276, "formatted": "Kericho County, Kenya"},
            {"Soil Type": "Clay", "Location Name": "KISUMU", "latitude": -0.1029109, "longitude": 34.7541761, "formatted": "Kisumu, Kisumu County, Kenya"},
            {"Soil Type": "White Soil", "Location Name": "CHEMILIL", "latitude": -0.1026006, "longitude": 35.1048749, "formatted": "Kisumu, Kisumu County, Kenya"},
            {"Soil Type": "White Soil", "Location Name": "KIBOS", "latitude": -0.066198, "longitude": 34.811711, "formatted": "Kibos, Miwani ward, Kisumu County, Kenya"},
            {"Soil Type": "Stone", "Location Name": "SINDO", "latitude": -0.5403063, "longitude": 34.1646971, "formatted": "Sindo (Kaksingiri West ward), Homa Bay County, Kenya"},
            {"Soil Type": "Kaolin Soil", "Location Name": "NYAMIRA", "latitude": -0.65179075, "longitude": 34.93416697, "formatted": "Nyamira County, Kenya"},
            {"Soil Type": "Yellow", "Location Name": "MAJENGO", "latitude": 0.0503153, "longitude": 34.7260582, "formatted": "Majengo (Central Maragoli ward), Vihiga County, Kenya"},
            {"Soil Type": "Clay Black", "Location Name": "KOMBEWA", "latitude": -0.1091443, "longitude": 34.525493, "formatted": "Kombewa (Central Seme ward), Kisumu County, Kenya"},
            {"Soil Type": "Clay Yellow", "Location Name": "MAJENGO (VIHIGA)", "latitude": 0.0503153, "longitude": 34.7260582, "formatted": "Majengo (Central Maragoli ward), Vihiga County, Kenya"},
            {"Soil Type": "Clay Black", "Location Name": "KANO", "latitude": -0.2214306, "longitude": 34.99133289, "formatted": "East Kano/Wawidhi ward, Kisumu County, Kenya"},
            {"Soil Type": "Clay Black", "Location Name": "KAPSABET", "latitude": 0.2004978, "longitude": 35.1011501, "formatted": "Kapsabet, Nandi County, Kenya"},
            {"Soil Type": "Silica (Quartz)", "Location Name": "NYADORERA", "latitude": 0.1120808, "longitude": 34.1052624, "formatted": "Usonga (Usonga ward), Siaya County, Kenya"},
            {"Soil Type": "Silica (Quartz)", "Location Name": "NYANDO", "latitude": -0.2098978, "longitude": 34.93766859, "formatted": "Nyando, Kenya"},
            {"Soil Type": "Silica (Quartz)", "Location Name": "YALA", "latitude": 0.1610984, "longitude": 34.6717048, "formatted": "Yala, Kakamega County, Kenya"},
            {"Soil Type": "Ball Clay", "Location Name": "MURAKA(KAKAMEGA)", "latitude": 0.252175828, "longitude": 34.75126788, "formatted": "Muraka - Ilesi Road, Kakamega County, 50100, Kenya"},
            {"Soil Type": "Ball Clay", "Location Name": "BUTERE", "latitude": 0.2163078, "longitude": 34.4981298, "formatted": "Butere (Marama Central ward), Kakamega County, Kenya"},
            {"Soil Type": "Ball Clay", "Location Name": "SIDINDI", "latitude": 0.1548411, "longitude": 34.3807269, "formatted": "Sidindi (Sidindi ward), Siaya County, Kenya"},
            {"Soil Type": "Ball Clay", "Location Name": "SIGOMERE", "latitude": 0.2173354, "longitude": 34.36105318, "formatted": "Sigomere ward, Siaya County, Kenya"},
            {"Soil Type": "Ball Clay", "Location Name": "UGUNJA", "latitude": 0.2036388, "longitude": 34.34032023, "formatted": "Ugunja, Kenya"},
            {"Soil Type": "Ball Clay", "Location Name": "BAR OBER", "latitude": 0.3057897, "longitude": 34.2884679, "formatted": "Bar Ober, Got Nanga - Bar Ober Road., East Ugenya ward, Kenya"},
            {"Soil Type": "Ball Clay", "Location Name": "HOMABAY", "latitude": -0.729425642, "longitude": 34.57732175, "formatted": "Homabay-Rongo, East Kamagambo ward, 40404, Kenya"},
            {"Soil Type": "Feldspar (Flux)", "Location Name": "HOMA MOUNTAIN  HOMABAY", "latitude": -0.5365493, "longitude": 34.46414134, "formatted": "Homa Bay, Homa Bay Town, Kenya"},
            {"Soil Type": "Feldspar (Flux)", "Location Name": "RANGWE AREA", "latitude": -0.60032, "longitude": 34.58353, "formatted": "Rangwe, HB, Kenya"},
            {"Soil Type": "Limestone (calcium carbonate)", "Location Name": "KAJIADO", "latitude": -2.12171705, "longitude": 36.78625504, "formatted": "Kajiado County, Kenya"},
            {"Soil Type": "Dolomite (calcium magnesium carbonate)", "Location Name": "KAJIADO ,", "latitude": -2.12171705, "longitude": 36.78625504, "formatted": "Kajiado County, Kenya"},
            {"Soil Type": "Dolomite (calcium magnesium carbonate)", "Location Name": "CHESAKAKI (BUNGOMA)", "latitude": 0.8, "longitude": 34.5, "formatted": "Chesakaki (Chesikaki ward), Bungoma County, Kenya"},
            {"Soil Type": "Talc", "Location Name": "WEST POKOT", "latitude": 1.8798608, "longitude": 35.21061301, "formatted": "West Pokot, Kenya"},
            {"Soil Type": "Talc", "Location Name": "KITUI", "latitude": -1.56422195, "longitude": 38.37281162, "formatted": "Kitui County, Kenya"},
            {"Soil Type": "Talc", "Location Name": "MACHAKOS", "latitude": -1.27900465, "longitude": 37.39526976, "formatted": "Machakos County, Kenya"}
        ];

        // Initialize map
        const map = L.map('map').setView([-0.0236, 37.9062], 7);

        // Base layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        });

        const esriLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri, Maxar, Earthstar Geographics',
            maxZoom: 19
        });

        osmLayer.addTo(map);

        // Layer groups
        const markersLayer = L.layerGroup().addTo(map);
        const ringsLayer = L.layerGroup().addTo(map);
        const labelsLayer = L.layerGroup().addTo(map);

        // Global variables
        let maxRadius = 25; // km
        let ringThickness = 3; // km
        let opacity = 0.6;
        let showLabels = true;

        // Group data by location (normalize location names)
        function groupDataByLocation() {
            const locationGroups = {};
            
            soilData.forEach(entry => {
                // Normalize location name (remove extra spaces, parentheses, etc.)
                const locName = entry["Location Name"].trim()
                    .replace(/\s+/g, ' ')
                    .replace(/\([^)]*\)/g, '')
                    .trim();
                
                const key = `${locName}_${entry.latitude.toFixed(6)}_${entry.longitude.toFixed(6)}`;
                
                if (!locationGroups[key]) {
                    locationGroups[key] = {
                        name: locName,
                        latitude: entry.latitude,
                        longitude: entry.longitude,
                        formatted: entry.formatted,
                        soilTypes: [],
                        count: 0
                    };
                }
                
                // Add soil type if not already present
                if (!locationGroups[key].soilTypes.includes(entry["Soil Type"])) {
                    locationGroups[key].soilTypes.push(entry["Soil Type"]);
                }
                
                locationGroups[key].count++;
            });
            
            return Object.values(locationGroups);
        }

        // Create concentric rings for locations
        function createConcentricRings() {
            ringsLayer.clearLayers();
            labelsLayer.clearLayers();
            
            const locationGroups = groupDataByLocation();
            
            locationGroups.forEach(location => {
                const numSoilTypes = location.soilTypes.length;
                
                if (numSoilTypes > 0) {
                    // Sort soil types by frequency (in this case, just by array order)
                    const sortedSoilTypes = location.soilTypes;
                    
                    // Calculate ring parameters
                    const baseRadius = maxRadius * 1000; // Convert to meters
                    
                    sortedSoilTypes.forEach((soilType, index) => {
                        const color = soilColors[soilType] || '#3498db';
                        
                        // Calculate inner and outer radius for this ring
                        const ringIndex = numSoilTypes - index - 1; // Reverse order (most common in center)
                        const innerRadius = (ringIndex * ringThickness) * 1000;
                        const outerRadius = ((ringIndex + 1) * ringThickness) * 1000;
                        
                        // Don't exceed max radius
                        if (outerRadius <= baseRadius) {
                            // Create donut-shaped ring using two circles
                            const outerCircle = L.circle([location.latitude, location.longitude], {
                                radius: outerRadius,
                                color: color,
                                fillColor: color,
                                fillOpacity: opacity,
                                weight: 2,
                                className: 'soil-ring'
                            });
                            
                            const innerCircle = L.circle([location.latitude, location.longitude], {
                                radius: innerRadius,
                                color: color,
                                fillColor: color,
                                fillOpacity: 0, // Transparent center
                                weight: 0,
                                className: 'soil-ring-inner'
                            });
                            
                            // Create a feature group for the donut
                            const donutRing = L.featureGroup([outerCircle, innerCircle]);
                            
                            // Add tooltip
                            donutRing.bindTooltip(`
                                <div style="text-align: center; padding: 5px;">
                                    <strong>${soilType}</strong><br>
                                    ${location.name}<br>
                                    Ring ${index + 1} of ${numSoilTypes}
                                </div>
                            `);
                            
                            donutRing.addTo(ringsLayer);
                            
                            // Add label if enabled
                            if (showLabels && numSoilTypes > 1) {
                                const labelRadius = (innerRadius + outerRadius) / 2;
                                const angle = (index * 2 * Math.PI) / numSoilTypes;
                                const labelLat = location.latitude + (labelRadius / 111320) * Math.sin(angle);
                                const labelLng = location.longitude + (labelRadius / (111320 * Math.cos(location.latitude * Math.PI / 180))) * Math.cos(angle);
                                
                                const label = L.marker([labelLat, labelLng], {
                                    icon: L.divIcon({
                                        className: 'ring-label',
                                        html: `<div style="
                                            background: rgba(255,255,255,0.9);
                                            border: 1px solid ${color};
                                            color: ${color};
                                            padding: 2px 6px;
                                            border-radius: 10px;
                                            font-size: 10px;
                                            font-weight: bold;
                                            text-align: center;
                                            white-space: nowrap;">
                                            ${soilType.split(' ')[0]}
                                        </div>`,
                                        iconSize: [60, 20],
                                        iconAnchor: [30, 10]
                                    })
                                });
                                
                                label.addTo(labelsLayer);
                            }
                        }
                    });
                    
                    // Add a central marker for locations with multiple soil types
                    if (numSoilTypes > 1) {
                        const centralIcon = L.divIcon({
                            className: 'multi-soil-marker',
                            html: `<div style="
                                background: white;
                                width: 20px;
                                height: 20px;
                                border-radius: 50%;
                                border: 3px solid #e74c3c;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                color: #e74c3c;
                                font-size: 10px;">
                                ${numSoilTypes}
                            </div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });
                        
                        const centralMarker = L.marker([location.latitude, location.longitude], {
                            icon: centralIcon
                        });
                        
                        centralMarker.bindTooltip(`
                            <div style="text-align: center;">
                                <strong>${location.name}</strong><br>
                                ${numSoilTypes} soil types
                            </div>
                        `);
                        
                        centralMarker.addTo(ringsLayer);
                    }
                }
            });
            
            // Update statistics
            updateStatistics(locationGroups);
        }

        // Create markers for individual soil records
        function createMarkers() {
            markersLayer.clearLayers();
            
            soilData.forEach((location, index) => {
                const soilType = location["Soil Type"];
                const color = soilColors[soilType] || '#3498db';
                
                // Create custom marker icon
                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background-color: ${color};
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        cursor: pointer;">
                    </div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                const marker = L.marker([location.latitude, location.longitude], {
                    icon: markerIcon,
                    title: `${soilType} - ${location["Location Name"]}`
                });
                
                // Create popup content
                const popupContent = `
                    <div style="padding: 10px; min-width: 250px;">
                        <div style="background: ${color}; color: white; padding: 8px; border-radius: 5px; margin-bottom: 10px; text-align: center; font-weight: bold;">
                            ${soilType}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong><i class="fas fa-map-pin"></i> Location:</strong> ${location["Location Name"]}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong><i class="fas fa-info-circle"></i> Details:</strong> ${location.formatted}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong><i class="fas fa-globe-africa"></i> Coordinates:</strong><br>
                            Latitude: ${location.latitude.toFixed(6)}<br>
                            Longitude: ${location.longitude.toFixed(6)}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                // Add click event
                marker.on('click', function() {
                    showLocationDetails(location);
                });
                
                marker.addTo(markersLayer);
            });
        }

        // Update statistics
        function updateStatistics(locationGroups) {
            const multiSoilLocations = locationGroups.filter(loc => loc.soilTypes.length > 1).length;
            const uniqueSoilTypes = [...new Set(soilData.map(item => item["Soil Type"]))];
            
            document.getElementById('total-soil-types').textContent = uniqueSoilTypes.length;
            document.getElementById('total-locations').textContent = soilData.length;
            document.getElementById('multi-soil-locations').textContent = multiSoilLocations;
        }

        // Show location details in sidebar
        function showLocationDetails(location) {
            const detailsDiv = document.getElementById('locationDetails');
            const infoSection = document.getElementById('selectedInfo');
            
            // Find all soil types at this location
            const locationGroups = groupDataByLocation();
            const thisLocation = locationGroups.find(loc => 
                Math.abs(loc.latitude - location.latitude) < 0.001 && 
                Math.abs(loc.longitude - location.longitude) < 0.001
            );
            
            let soilTypesHtml = '';
            if (thisLocation && thisLocation.soilTypes.length > 0) {
                soilTypesHtml = thisLocation.soilTypes.map(soilType => {
                    const color = soilColors[soilType] || '#3498db';
                    return `<div class="ring-info">
                        <span class="ring-sample" style="background: ${color};"></span>
                        <span>${soilType}</span>
                    </div>`;
                }).join('');
            }
            
            detailsDiv.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Location:</span>
                    <span class="info-value">${location["Location Name"]}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Soil Types:</span>
                    <span class="info-value">${thisLocation ? thisLocation.soilTypes.length : 1}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Latitude:</span>
                    <span class="info-value">${location.latitude.toFixed(6)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Longitude:</span>
                    <span class="info-value">${location.longitude.toFixed(6)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Area:</span>
                    <span class="info-value">${location.formatted}</span>
                </div>
                ${thisLocation && thisLocation.soilTypes.length > 1 ? 
                    `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #dee2e6;">
                        <div style="font-weight: bold; margin-bottom: 5px;">Soil Types at this location:</div>
                        ${soilTypesHtml}
                    </div>` : ''
                }
            `;
            
            infoSection.style.display = 'block';
        }

        // Create legend
        function createLegend() {
            const legendDiv = document.getElementById('legend');
            legendDiv.innerHTML = '';
            
            // Count soil types
            const soilTypeCounts = {};
            soilData.forEach(location => {
                const soilType = location["Soil Type"];
                soilTypeCounts[soilType] = (soilTypeCounts[soilType] || 0) + 1;
            });
            
            // Sort by count (descending)
            const sortedSoilTypes = Object.keys(soilTypeCounts).sort((a, b) => soilTypeCounts[b] - soilTypeCounts[a]);
            
            // Create legend items
            sortedSoilTypes.forEach(soilType => {
                const count = soilTypeCounts[soilType];
                const color = soilColors[soilType] || '#3498db';
                
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="color-box" style="background-color: ${color};"></div>
                    <span class="soil-name">${soilType}</span>
                    <span class="count">${count}</span>
                `;
                
                // Add click event to filter by soil type
                legendItem.addEventListener('click', function() {
                    filterBySoilType(soilType);
                });
                
                legendDiv.appendChild(legendItem);
            });
        }

        // Filter by soil type
        function filterBySoilType(soilType) {
            // Zoom to locations with this soil type
            const locationsWithSoilType = soilData.filter(loc => loc["Soil Type"] === soilType);
            if (locationsWithSoilType.length === 0) return;
            
            // Create bounds
            const bounds = L.latLngBounds(locationsWithSoilType.map(loc => [loc.latitude, loc.longitude]));
            map.fitBounds(bounds.pad(0.2));
            
            // Show first location details
            showLocationDetails(locationsWithSoilType[0]);
        }

        // Initialize the map
        function initMap() {
            createConcentricRings();
            createMarkers();
            createLegend();
            
            // Event listeners for controls
            document.getElementById('baseMapSelector').addEventListener('change', function(e) {
                map.removeLayer(osmLayer);
                map.removeLayer(esriLayer);
                
                if (e.target.value === 'osm') {
                    osmLayer.addTo(map);
                } else {
                    esriLayer.addTo(map);
                }
            });
            
            document.getElementById('opacitySlider').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('opacityValue').textContent = `${value}%`;
                opacity = value / 100;
                
                // Update ring opacity
                ringsLayer.eachLayer(layer => {
                    if (layer instanceof L.Circle) {
                        layer.setStyle({ fillOpacity: opacity });
                    } else if (layer instanceof L.FeatureGroup) {
                        layer.eachLayer(circle => {
                            if (circle instanceof L.Circle) {
                                circle.setStyle({ fillOpacity: opacity });
                            }
                        });
                    }
                });
            });
            
            document.getElementById('maxRadiusSlider').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('maxRadiusValue').textContent = `${value} km`;
                maxRadius = parseInt(value);
                createConcentricRings();
            });
            
            document.getElementById('thicknessSlider').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('thicknessValue').textContent = `${value} km`;
                ringThickness = parseInt(value);
                createConcentricRings();
            });
            
            document.getElementById('togglePoints').addEventListener('click', function() {
                const checkbox = document.getElementById('pointsCheckbox');
                checkbox.checked = !checkbox.checked;
                
                if (checkbox.checked) {
                    map.addLayer(markersLayer);
                    this.classList.add('active');
                } else {
                    map.removeLayer(markersLayer);
                    this.classList.remove('active');
                }
            });
            
            document.getElementById('toggleRings').addEventListener('click', function() {
                const checkbox = document.getElementById('ringsCheckbox');
                checkbox.checked = !checkbox.checked;
                
                if (checkbox.checked) {
                    map.addLayer(ringsLayer);
                    this.classList.add('active');
                } else {
                    map.removeLayer(ringsLayer);
                    this.classList.remove('active');
                }
            });
            
            document.getElementById('toggleLabels').addEventListener('click', function() {
                const checkbox = document.getElementById('labelsCheckbox');
                checkbox.checked = !checkbox.checked;
                showLabels = checkbox.checked;
                
                if (checkbox.checked) {
                    map.addLayer(labelsLayer);
                    this.classList.add('active');
                } else {
                    map.removeLayer(labelsLayer);
                    this.classList.remove('active');
                }
            });
            
            document.getElementById('toggle-rings').addEventListener('click', function() {
                const checkbox = document.getElementById('ringsCheckbox');
                checkbox.checked = !checkbox.checked;
                
                if (checkbox.checked) {
                    map.addLayer(ringsLayer);
                    document.getElementById('toggleRings').classList.add('active');
                } else {
                    map.removeLayer(ringsLayer);
                    document.getElementById('toggleRings').classList.remove('active');
                }
            });
            
            document.getElementById('zoom-to-kenya').addEventListener('click', function() {
                map.setView([-0.0236, 37.9062], 7);
            });
            
            document.getElementById('reset-view').addEventListener('click', function() {
                map.setView([-0.0236, 37.9062], 7);
                document.getElementById('opacitySlider').value = 60;
                document.getElementById('opacityValue').textContent = '60%';
                opacity = 0.6;
                document.getElementById('maxRadiusSlider').value = 25;
                document.getElementById('maxRadiusValue').textContent = '25 km';
                maxRadius = 25;
                document.getElementById('thicknessSlider').value = 3;
                document.getElementById('thicknessValue').textContent = '3 km';
                ringThickness = 3;
                createConcentricRings();
            });
            
            // Show initial details
            if (soilData.length > 0) {
                showLocationDetails(soilData[0]);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>